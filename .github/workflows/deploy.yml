name: Deploy to Cloud Run

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: ${{ secrets.CLOUD_RUN_REGION || 'us-central1' }}
  BACKEND_SERVICE: ${{ secrets.CLOUD_RUN_SERVICE_BACKEND || 'meridian-backend' }}
  AGENTS_SERVICE: ${{ secrets.CLOUD_RUN_SERVICE_AGENTS || 'meridian-agents' }}

jobs:
  deploy-backend:
    name: Deploy Backend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      - uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}
      - name: Build backend image
        run: |
          gcloud builds submit \
            --project $PROJECT_ID \
            --tag gcr.io/$PROJECT_ID/meridian-backend:${{ github.sha }} \
            -f Dockerfile.backend .
      - name: Deploy backend to Cloud Run
        run: |
          gcloud run deploy $BACKEND_SERVICE \
            --project $PROJECT_ID \
            --region $REGION \
            --image gcr.io/$PROJECT_ID/meridian-backend:${{ github.sha }} \
            --allow-unauthenticated

  deploy-agents:
    name: Deploy Agents
    runs-on: ubuntu-latest
    needs: deploy-backend
    steps:
      - uses: actions/checkout@v4
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      - uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}
      - name: Build agents image
        run: |
          gcloud builds submit \
            --project $PROJECT_ID \
            --tag gcr.io/$PROJECT_ID/meridian-agents:${{ github.sha }} \
            -f Dockerfile.agents .
      - name: Deploy agents to Cloud Run
        run: |
          gcloud run deploy $AGENTS_SERVICE \
            --project $PROJECT_ID \
            --region $REGION \
            --image gcr.io/$PROJECT_ID/meridian-agents:${{ github.sha }} \
            --allow-unauthenticated

