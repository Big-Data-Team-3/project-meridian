name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:

jobs:
  frontend:
    name: Frontend (lint + tests)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: meridian-frontend
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: meridian-frontend/package-lock.json
      - run: npm ci
      - run: npm run lint
      - run: npm run test -- --runInBand

  backend:
    name: Backend (pytest)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: meridian-backend
    env:
      DB_HOST: ${{ secrets.DB_HOST || 'localhost' }}
      DB_USER: ${{ secrets.DB_USER || 'postgres' }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD || 'postgres' }}
      DB_NAME: ${{ secrets.DB_NAME || 'postgres' }}
      DB_TYPE: postgresql
      AGENTS_SERVICE_URL: ${{ secrets.AGENTS_SERVICE_URL || 'http://localhost:8001' }}
      GOOGLE_APPLICATION_CREDENTIALS: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS_PATH || '' }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: requirements.txt
      - run: pip install -r requirements.txt
      - run: pytest -m "not slow" -v

  agents:
    name: Agents (pytest + eval sweep)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: meridian-agents
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: requirements.txt
      - run: pip install -r requirements.txt
      - run: pytest -v

